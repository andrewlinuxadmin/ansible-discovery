# Ansible Discovery

**Automated infrastructure discovery system for Linux servers using Ansible**

A comprehensive solution that collects detailed information about processes, Java applications, web servers, PHP applications, and system services, storing data in MongoDB with intelligent caching for analysis and reporting.

## ‚ú® Features

### üîç **Multi-Stage Discovery Pipeline**

- **Selective Collection**: Use `collector_only` parameter for targeted discovery
- **Process Analysis**: Smart detection via custom `process_facts` module
- **Java Applications**: Deep inspection of Tomcat, JBoss/Wildfly, and standalone JARs
- **Web Servers**: Apache HTTPD and NGINX with full configuration parsing
- **PHP Applications**: Auto-discovery and configuration parsing with dynamic version detection
- **System Information**: Packages, services, network ports, firewall, and bootloader

### üöÄ **Advanced Capabilities**

- **Custom Modules**: Four specialized modules for process and configuration discovery
- **Container Detection**: Automatic adjustment for containerized environments
- **Custom Filters**: File existence checks and path validation
- **MongoDB Caching**: Persistent storage with configurable TTL
- **Cross-Platform**: RHEL, Debian, SUSE support with unified output

### üõ† **Modular Architecture**

- **Selective Execution**: Target specific collectors with absolute precedence
- **Custom Modules**: Standalone parsers with minimal dependencies
- **Conditional Processing**: Process-based discovery for Java/web applications
- **Graceful Degradation**: Fallback mechanisms for missing tools/permissions

## üöÄ Quick Start

### Prerequisites

- **System**: Linux with Python 3.9+
- **Database**: MongoDB instance (local or remote)
- **Network**: SSH connectivity to target servers
- **Permissions**: Sudo access on target machines

### Installation

1. **Clone and setup environment**

   ```bash
   git clone https://github.com/andrewlinuxadmin/ansible-discovery.git
   cd ansible-discovery
   
   # Setup Python environment
   source activate
   pip install -r pip-venv-requirements.txt
   ```

2. **Configure Ansible environment**

   ```bash
   cd playbooks
   
   # Install collections
   ansible-galaxy collection install -r galaxy-requirements.yaml
   
   # Setup configuration
   cp ansible.cfg.example ansible.cfg
   cp inventory.example inventory
   ```

3. **Start MongoDB and configure inventory**

   ```bash
   # Docker (recommended)
   docker run -d -p 27017:27017 --name ansible-discovery-mongo mongo:latest
   
   # Edit inventory with your target servers
   nano inventory
   ```

## üéØ Usage

### Basic Discovery

```bash
# Full discovery (all collectors)
ansible-playbook discovery.yaml

# Selective discovery (single collector)
ansible-playbook discovery.yaml -e collector_only=java

# Individual collector control
ansible-playbook discovery.yaml -e collector_packages=false -e collector_services=false
```

### Collector Selection

The discovery system uses a **selective collection approach** with absolute precedence:

| Command                    | Description                | Collectors Executed |
|----------------------------|----------------------------|---------------------|
| `collector_only=java`      | Java applications only     | java                |
| `collector_only=apache`    | Apache web server only     | apache              |
| `collector_only=nginx`     | NGINX web server only      | nginx               |
| `collector_only=php`       | PHP configuration only     | php                 |
| `collector_only=packages`  | Package information only   | packages            |
| No `collector_only`        | All enabled collectors     | all (default)       |

### Available Collectors

| Tag          | Description                      | Scope        | Output                           |
|--------------|----------------------------------|--------------|----------------------------------|
| `packages`   | System package discovery         | All hosts    | Package list with versions       |
| `services`   | Service status and configuration | All hosts    | Service states and configs       |
| `ports`      | Network ports and listening svc  | All hosts    | Port mappings and processes      |
| `java`       | Java application discovery       | Java hosts   | Tomcat, JBoss, JAR details       |
| `apache`     | Apache HTTPD configuration       | Apache hosts | VirtualHosts, modules, config    |
| `nginx`      | NGINX configuration              | NGINX hosts  | Server blocks, PHP-FPM detection |
| `php`        | PHP configuration discovery      | PHP hosts    | Settings, extensions, versions   |
| `firewall`   | Firewall rules and status        | All hosts    | Rules, zones, policies           |
| `selinux`    | SELinux status and policies      | All hosts    | Mode, policies, contexts         |
| `blockdev`   | Block device information         | All hosts    | Disks, mounts, filesystems       |
| `bootloader` | Boot configuration               | All hosts    | GRUB, kernel parameters          |

## üîß Architecture

### Data Flow

```text
discovery.yaml ‚Üí prereqs.yaml (selective config) ‚Üí process_facts (custom module) ‚Üí
                 ‚Üí collectors/*.yaml (conditional execution) ‚Üí
                 ‚Üí custom modules (config parsing) ‚Üí
                 ‚Üí MongoDB cache (TTL-based)
```

### Custom Modules

Located in `playbooks/library/`:

| Module                  | Purpose                        | Dependencies    | Status          |
|-------------------------|--------------------------------|-----------------|-----------------|
| `process_facts`         | System process discovery       | None            | ‚úÖ Production   |
| `apache_config_parser`  | Apache configuration parsing   | `apacheconfig`  | ‚úÖ Production   |
| `php_config_parser`     | PHP configuration discovery    | None            | ‚úÖ Production   |
| `nginx_config_parser`   | NGINX configuration parsing    | None            | ‚úÖ Production   |

#### Module Capabilities

**NGINX Discovery Features:**

- **Process Detection**: Supports Software Collections (SCL) and standard installations
- **Configuration Parsing**: Complete NGINX config with includes and server blocks
- **PHP-FPM Detection**: Automatic detection of PHP-FPM integration via `fastcgi_pass` and related directives
- **Multi-Format Output**: Both readable hierarchical and technical crossplane formats
- **Security Filtering**: Option to exclude sensitive directives from output

**PHP Configuration Features:**

- **Dynamic Version Discovery**: Auto-detects installed PHP versions from system directories
- **Multi-Distribution**: RHEL, Debian, SUSE support with unified output
- **SCL Support**: Software Collections PHP installations (rh-php74, etc.)
- **Extension Analysis**: Loaded modules and configuration parsing

### Custom Filters

Enhanced file operations with custom filters:

- **`file_exists`**: Check if a specific file exists (returns boolean)
- **`path_exists`**: Check if a path exists (file or directory)
- **`file_readable`**: Check if a file exists and is readable by current user

```yaml
# Example usage in discovery
- name: Check if Tomcat config exists
  debug:
    msg: "Tomcat found at {{ tomcat_home }}"
  when: "{{ tomcat_home }}/conf/server.xml" | file_exists

- name: Process only readable config files
  include_tasks: process_config.yaml
  when: item | file_readable
  loop: "{{ config_files }}"
```

**Configuration**: Add `filter_plugins = ./filter_plugins` to your `ansible.cfg`.

### MongoDB Caching

All discovered facts are cached in MongoDB with configurable TTL:

- **Performance**: Avoid re-discovery on subsequent runs
- **Persistence**: Data survives across playbook executions
- **Flexibility**: TTL=0 for infinite cache (current default)

### Cross-Platform Support

Hybrid collection strategy ensures compatibility:

- **Primary**: Uses official `fedora.linux_system_roles` when available
- **Fallback**: Custom modules and shell commands for older systems
- **Container**: Automatic detection and adjusted behavior
- **Distributions**: RHEL, Debian, SUSE support with unified output

## üõ† Development Environment

### Setup for Contributors

1. **Fork and clone the repository**

   ```bash
   git clone https://github.com/YOUR_USERNAME/ansible-discovery.git
   cd ansible-discovery
   ```

2. **Install development dependencies**

   ```bash
   # Setup Python environment
   source activate
   pip install -r pip-venv-requirements.txt
   ```

3. **Setup Ansible environment**

   ```bash
   cd playbooks
   
   # Install required collections
   ansible-galaxy collection install -r galaxy-requirements.yaml
   
   # Setup configuration files
   cp ansible.cfg.example ansible.cfg
   cp inventory.example inventory
   ```

4. **Configure development tools**

   ```bash
   # Install markdown linting (optional)
   npm install -g markdownlint-cli
   
   # Install Python linting tools (optional)
   pip install flake8 pylint black
   ```

5. **VS Code setup (recommended)**

   Install required extensions:

   - [Red Hat Ansible](https://marketplace.visualstudio.com/items?itemName=redhat.ansible)
   - [Jinja HTML](https://marketplace.visualstudio.com/items?itemName=samuelcolvin.jinjahtml)

   ```bash
   # Open project in VS Code
   code .
   ```

### Running Tests

#### Basic Testing

```bash
# Validate playbook syntax
ansible-playbook --syntax-check discovery.yaml

# Test selective collection
ansible-playbook discovery.yaml -e collector_only=java --check

# Run with debug output
ansible-playbook discovery.yaml -e debug=true -e log=true
```

#### Custom Filter Testing

```bash
# Test individual filters
ansible localhost -m debug -a "msg={{ '/etc/passwd' | file_exists }}"
ansible localhost -m debug -a "msg={{ '/tmp' | path_exists }}"
ansible localhost -m debug -a "msg={{ '/etc/shadow' | file_readable }}"

# Run comprehensive filter tests
ansible-playbook filter_plugins/tests/test_file_utils.yaml
./filter_plugins/tests/run_tests.sh
```

#### Custom Module Testing

```bash
# Test individual modules
ansible localhost -m process_facts
ansible localhost -m php_config_parser
ansible localhost -m apache_config_parser -a "path=/etc/httpd/conf/httpd.conf configroot=/etc/httpd"
ansible localhost -m nginx_config_parser -a "path=/etc/nginx/nginx.conf"

# Run module tests (if available)
./library/tests/run_tests.sh
```

#### Cache Management

```bash
# List cached hosts
./scripts/manage-cache.sh --list

# Clear all cache
./scripts/clear-cache-simple.sh

# Clear cache for specific hosts
./scripts/manage-cache.sh server1.example.com server2.example.com

# Force clear all cache (automation)
./scripts/clear-cache-simple.sh --force
```

#### Performance Testing

```bash
# Time discovery execution
time ansible-playbook discovery.yaml

# Test MongoDB caching
ansible-playbook discovery.yaml -e collector_only=packages  # First run
time ansible-playbook discovery.yaml -e collector_only=packages  # Cached run
```

### Project Structure

```text
ansible-discovery/
‚îú‚îÄ‚îÄ playbooks/
‚îÇ   ‚îú‚îÄ‚îÄ discovery.yaml                 # Main discovery orchestrator
‚îÇ   ‚îú‚îÄ‚îÄ prereqs.yaml                   # Collection variables configuration
‚îÇ   ‚îú‚îÄ‚îÄ collectors/                    # Discovery modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ packages.yaml              # Package discovery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services.yaml              # Service discovery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ports.yaml                 # Network ports discovery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ java/                      # Java application discovery
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ java.yaml              # Java process classification
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tomcat.yaml            # Tomcat-specific discovery
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jboss.yaml             # JBoss/Wildfly discovery
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jar.yaml               # Generic JAR analysis
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apache.yaml                # Apache HTTPD discovery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nginx.yaml                 # NGINX discovery with PHP-FPM detection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ php.yaml                   # PHP configuration discovery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ firewall.yaml              # Firewall discovery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ selinux.yaml               # SELinux discovery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blockdev.yaml              # Block device discovery
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bootloader.yaml            # Bootloader discovery
‚îÇ   ‚îú‚îÄ‚îÄ library/                       # Custom Ansible modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ process_facts.py           # Process discovery module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apache_config_parser.py    # Apache config parser
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ php_config_parser.py       # PHP config parser
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nginx_config_parser.py     # NGINX config parser (production)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docs/                      # Module documentation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/                     # Module tests
‚îÇ   ‚îú‚îÄ‚îÄ filter_plugins/                # Custom Ansible filters
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file_utils.py              # File operation filters
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md                  # Filter documentation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/                     # Filter tests
‚îÇ   ‚îú‚îÄ‚îÄ ansible.cfg.example            # Ansible configuration template
‚îÇ   ‚îú‚îÄ‚îÄ inventory.example              # Inventory template
‚îÇ   ‚îî‚îÄ‚îÄ galaxy-requirements.yaml       # Required Ansible collections
‚îú‚îÄ‚îÄ scripts/                           # Utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ manage-cache.sh                # MongoDB cache management
‚îÇ   ‚îú‚îÄ‚îÄ clear-cache-simple.sh          # Simple cache clearing
‚îÇ   ‚îî‚îÄ‚îÄ README.md                      # Scripts documentation
‚îú‚îÄ‚îÄ tests/                             # Integration tests
‚îú‚îÄ‚îÄ ARCHITECTURE.md                    # Technical architecture documentation
‚îú‚îÄ‚îÄ DEPLOYMENT.md                      # Deployment guide
‚îú‚îÄ‚îÄ DOCS.md                            # Additional documentation
‚îú‚îÄ‚îÄ TODO.md                            # Future development roadmap
‚îî‚îÄ‚îÄ README.md                          # This file
```

## üìã Contributing

### Development Guidelines

1. **Code Quality**
   - Follow PEP 8 for Python code
   - Use meaningful variable names
   - Include docstrings for all functions
   - Maintain Ansible best practices

2. **Testing**
   - Test all changes locally before submitting
   - Include unit tests for new modules
   - Update integration tests as needed
   - Verify markdown formatting

3. **Documentation**
   - Update relevant documentation
   - Include examples in module documentation
   - Update this README for significant changes
   - Follow markdown standards

4. **Pull Requests**
   - Create feature branches from `main`
   - Include clear commit messages
   - Reference relevant issues
   - Include testing evidence

### Custom Module Development

When creating new custom modules:

1. **Create module**: Place in `playbooks/library/`
2. **Documentation**: Create `.md` file in `library/docs/`
3. **Tests**: Add tests in `library/tests/`
4. **Integration**: Update collectors as needed
5. **Dependencies**: Document any external requirements

### Filter Development

When creating new custom filters:

1. **Add filter**: Implement in `filter_plugins/file_utils.py`
2. **Tests**: Add tests in `filter_plugins/tests/`
3. **Documentation**: Update `filter_plugins/README.md`
4. **Examples**: Include usage examples

## üîÆ Roadmap

See [TODO.md](TODO.md) for detailed development roadmap.

### Planned Features

- **Container Support**: Docker process discovery and mapping
- **Additional Languages**: .NET, Python, Ruby application discovery
- **Security Scanning**: Vulnerability and compliance checking
- **Reporting**: Web dashboard for discovered infrastructure

### Development Status

| Component            | Status              | Notes                               |
|----------------------|---------------------|-------------------------------------|
| Java Discovery       | ‚úÖ Complete         | Tomcat, JBoss, JAR support          |
| Apache Discovery     | ‚úÖ Complete         | Full configuration parsing          |
| PHP Discovery        | ‚úÖ Complete         | Dynamic version detection           |
| NGINX Discovery      | ‚úÖ Complete         | Config parsing, PHP-FPM detection   |
| Container Discovery  | üìã Planned          | Docker integration roadmap          |
| .NET Discovery       | üìã Planned          | Core/Framework detection            |

## üìû Support

- **Issues**: [GitHub Issues](https://github.com/andrewlinuxadmin/ansible-discovery/issues)
- **Documentation**: [Project Wiki](https://github.com/andrewlinuxadmin/ansible-discovery/wiki)
- **Discussions**: [GitHub Discussions](https://github.com/andrewlinuxadmin/ansible-discovery/discussions)

## üìÑ License

This project is licensed under the GPL-3.0 License - see the [LICENSE](LICENSE) file for details.

## üôè Acknowledgments

- **Ansible Community** for the excellent automation framework
- **MongoDB** for reliable caching infrastructure  
- **nginx-crossplane** project for NGINX configuration parsing inspiration
- **Contributors** who help improve this project

---

**Made with ‚ù§Ô∏è by the Ansible community**

- Process analysis powered by custom modules and shell scripting
